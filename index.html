<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NWS 7-Day Forecast Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    .popup h3 { margin: 0 0 6px 0; font-size: 16px; }
    .meta { color: #555; font-size: 12px; margin-bottom: 8px; }
    .period { margin: 10px 0; }
    .alerts { margin-top: 10px; padding-top: 8px; border-top: 1px solid #ddd; }
    .alert-item { margin: 6px 0; }
    .badge {
      display: inline-block; padding: 2px 6px; border: 1px solid #ccc;
      border-radius: 10px; font-size: 11px; margin-right: 6px;
    }
    .hint {
      position: absolute; top: 10px; left: 10px; z-index: 999;
      background: rgba(255,255,255,0.92); padding: 8px 10px; border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.15);
      font: 13px/1.3 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="hint">Click anywhere to load the NWS 7-day forecast + active alerts for that point.</div>

  <script>
    // --- Config ---
    const INITIAL_CENTER = [40.1, -74.5]; // NJ-ish
    const INITIAL_ZOOM = 7;

    // --- Map setup ---
    const map = L.map("map").setView(INITIAL_CENTER, INITIAL_ZOOM);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let clickMarker = null;
    let inFlight = 0; // "latest click wins" guard

    function esc(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    function fmtLatLon(lat, lon) {
      return `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
    }

    async function fetchJson(url) {
      // Don't try to set User-Agent headers in browser JS.
      const res = await fetch(url, { method: "GET" });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} for ${url}${txt ? " — " + txt.slice(0, 160) : ""}`);
      }
      return res.json();
    }

    // --- 7-day daily-row grouping helpers ---
    function dateKey(iso) {
      const d = new Date(iso);
      // Local date key for grouping
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
    }

    function prettyDateFromKey(key) {
      // key = YYYY-MM-DD
      const [y, m, d] = key.split("-").map(Number);
      const dt = new Date(y, m - 1, d);
      return dt.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
    }

    function toDaily(periods) {
      const byDay = new Map();

      for (const p of periods) {
        if (!p?.startTime) continue;
        const key = dateKey(p.startTime);

        if (!byDay.has(key)) byDay.set(key, { dateKey: key, day: null, night: null });
        const row = byDay.get(key);

        if (p.isDaytime) row.day = p;
        else row.night = p;
      }

      return Array.from(byDay.values()).slice(0, 7);
    }

    function tempStr(p) {
      if (!p || p.temperature == null) return "—";
      const unit = p.temperatureUnit || "";
      return `${p.temperature}°${unit}`;
    }

    function buildForecastHtml(locationLabel, lat, lon, periods) {
      const dailyRows = toDaily(periods);

      const rowsHtml = dailyRows.map(r => {
        const day = r.day;
        const night = r.night;

        const dayText = day?.shortForecast ? esc(day.shortForecast) : "—";
        const nightText = night?.shortForecast ? esc(night.shortForecast) : "—";

        const high = tempStr(day);
        const low = tempStr(night);

        const dayWind = day ? [day.windSpeed, day.windDirection].filter(Boolean).join(" ") : "";
        const nightWind = night ? [night.windSpeed, night.windDirection].filter(Boolean).join(" ") : "";

        return `
          <div class="period">
            <strong>${esc(prettyDateFromKey(r.dateKey))}</strong><br/>
            <span class="meta">High: ${esc(high)} · Low: ${esc(low)}</span><br/>
            <div><strong>Day:</strong> ${dayText}${dayWind ? ` <span class="meta">(${esc(dayWind)})</span>` : ""}</div>
            <div><strong>Night:</strong> ${nightText}${nightWind ? ` <span class="meta">(${esc(nightWind)})</span>` : ""}</div>
          </div>
        `;
      }).join("");

      return `
        <div class="popup">
          <h3>${esc(locationLabel)}</h3>
          <div class="meta">Point: ${esc(fmtLatLon(lat, lon))}</div>
          ${rowsHtml || "<em>No forecast periods returned.</em>"}
        </div>
      `;
    }

    function buildAlertsHtml(alertFeatures) {
      if (!Array.isArray(alertFeatures) || alertFeatures.length === 0) {
        return `<div class="alerts"><strong>Active alerts:</strong> None</div>`;
      }
      const items = alertFeatures.slice(0, 5).map(f => {
        const p = (f && f.properties) ? f.properties : {};
        const event = p.event || "Alert";
        const severity = p.severity || "info";
        const headline = p.headline || p.description || "";
        return `
          <div class="alert-item">
            <span class="badge">${esc(severity)}</span>
            <strong>${esc(event)}</strong><br/>
            <span class="meta">${esc(headline).slice(0, 180)}${headline.length > 180 ? "…" : ""}</span>
          </div>
        `;
      }).join("");
      return `<div class="alerts"><strong>Active alerts:</strong>${items}</div>`;
    }

    // --- Click handler: /points -> forecast + alerts ---
    map.on("click", async (e) => {
      const requestId = ++inFlight;
      const { lat, lng } = e.latlng;

      if (clickMarker) map.removeLayer(clickMarker);
      clickMarker = L.marker([lat, lng]).addTo(map);

      const popup = L.popup({ maxWidth: 380 })
        .setLatLng([lat, lng])
        .setContent(`<div class="popup"><h3>Loading…</h3><div class="meta">${esc(fmtLatLon(lat, lng))}</div></div>`)
        .openOn(map);

      try {
        // 1) Discover endpoints for the point
        const pointsUrl = `https://api.weather.gov/points/${lat.toFixed(4)},${lng.toFixed(4)}`;
        const pointData = await fetchJson(pointsUrl);
        if (requestId !== inFlight) return;

        const props = pointData?.properties || {};
        const forecastUrl = props.forecast; // ✅ 7-day style (day/night periods), NOT hourly
        const rel = props?.relativeLocation?.properties || null;
        const locationLabel = rel ? `${rel.city}, ${rel.state}` : (props.radarStation || "NWS Point");

        if (!forecastUrl) throw new Error("No forecast URL returned from /points");

        // 2) Fetch forecast periods (day/night)
        const forecastData = await fetchJson(forecastUrl);
        if (requestId !== inFlight) return;

        const periods = Array.isArray(forecastData?.properties?.periods)
          ? forecastData.properties.periods
          : [];

        // 3) Fetch active alerts for the point
        const alertsUrl = `https://api.weather.gov/alerts/active?point=${lat.toFixed(4)},${lng.toFixed(4)}`;
        let alertsHtml = "";
        try {
          const alertsData = await fetchJson(alertsUrl);
          if (requestId !== inFlight) return;
          const features = Array.isArray(alertsData?.features) ? alertsData.features : [];
          alertsHtml = buildAlertsHtml(features);
        } catch (err) {
          alertsHtml = `<div class="alerts"><strong>Active alerts:</strong> <em>Unavailable</em></div>`;
        }

        const html = buildForecastHtml(locationLabel, lat, lng, periods) + alertsHtml;
        popup.setContent(html);
      } catch (err) {
        popup.setContent(`
          <div class="popup">
            <h3>Error</h3>
            <div class="meta">${esc(fmtLatLon(lat, lng))}</div>
            <div>${esc(err?.message || String(err))}</div>
            <div class="meta">Tip: GitHub Pages should work; if testing locally, use a local server (not file://).</div>
          </div>
        `);
      }
    });
  </script>
</body>
</html>
